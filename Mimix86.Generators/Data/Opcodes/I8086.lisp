; ==============================================================================
; File:   I8086.lisp
; Author: Cole Tobin
; ==============================================================================
; Copyright (c) 2023 Cole Tobin
;
; This file is part of Mimix86.
;
; Mimix86 is free software: you can redistribute it and/or modify it under the
;   terms of the GNU General Public License as published by the Free Software
;   Foundation, either version 3 of the License, or (at your option) any later
;   version.
;
; Mimix86 is distributed in the hope that it will be useful, but WITHOUT ANY
;   WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS
;   FOR A PARTICULAR PURPOSE. See the GNU General Public License for more
;   details.
;
; You should have received a copy of the GNU General Public License along with
;   Mimix86. If not, see <https://www.gnu.org/licenses/>.
; ==============================================================================

(file
    (name  I8086)
    (summary
        (
            "The instructions added with the original 8086."
            "Undefined instructions are available with <see cref=\"I8086Undefined\" />."
        )
    )
)


(one-b-prefixes
    (26 seg-es)
    (2E seg-cs)
    (36 seg-ss)
    (3E seg-ds)
    (F0 lock)
    (F2 rep-ne)
    (F3 rep-e)
)


(instructions
    (ADD     (Eb Gb)  (00 /r)     (lockable))
    (ADD     (Ew Gw)  (01 /r)     (lockable))
    (ADD     (Gb Eb)  (02 /r)     ())
    (ADD     (Gw Ew)  (03 /r)     ())
    (ADD     (AL Ib)  (04 ib)     ())
    (ADD     (AX Iw)  (05 iw)     ())
    (PUSH    (ES)     (06)        ())
    (POP     (ES)     (07)        ())
    (OR      (Eb Gb)  (08 /r)     (lockable))
    (OR      (Ew Gw)  (09 /r)     (lockable))
    (OR      (Gb Eb)  (0A /r)     ())
    (OR      (Gw Ew)  (0B /r)     ())
    (OR      (AL Ib)  (0C ib)     ())
    (OR      (AX Iw)  (0D iw)     ())
    (PUSH    (CS)     (0E)        ())
    (ADC     (Eb Gb)  (10 /r)     (lockable))
    (ADC     (Ew Gw)  (11 /r)     (lockable))
    (ADC     (Gb Eb)  (12 /r)     ())
    (ADC     (Gw Ew)  (13 /r)     ())
    (ADC     (AL Ib)  (14 ib)     ())
    (ADC     (AX Iw)  (15 iw)     ())
    (PUSH    (SS)     (16)        ())
    (POP     (SS)     (17)        ())
    (SBB     (Eb Gb)  (18 /r)     (lockable))
    (SBB     (Ew Gw)  (19 /r)     (lockable))
    (SBB     (Gb Eb)  (1A /r)     ())
    (SBB     (Gw Ew)  (1B /r)     ())
    (SBB     (AL Ib)  (1C ib)     ())
    (SBB     (AX Iw)  (1D iw)     ())
    (PUSH    (DS)     (1E)        ())
    (POP     (DS)     (1F)        ())
    (AND     (Eb Gb)  (20 /r)     (lockable))
    (AND     (Ew Gw)  (21 /r)     (lockable))
    (AND     (Gb Eb)  (22 /r)     ())
    (AND     (Gw Ew)  (23 /r)     ())
    (AND     (AL Ib)  (24 ib)     ())
    (AND     (AX Iw)  (25 iw)     ())
    (DAA     ()       (27)        ())
    (SUB     (Eb Gb)  (28 /r)     (lockable))
    (SUB     (Ew Gw)  (29 /r)     (lockable))
    (SUB     (Gb Eb)  (2A /r)     ())
    (SUB     (Gw Ew)  (2B /r)     ())
    (SUB     (AL Ib)  (2C ib)     ())
    (SUB     (AX Iw)  (2D iw)     ())
    (DAS     ()       (2F)        ())
    (XOR     (Eb Gb)  (30 /r)     (lockable))
    (XOR     (Ew Gw)  (31 /r)     (lockable))
    (XOR     (Gb Eb)  (32 /r)     ())
    (XOR     (Gw Ew)  (33 /r)     ())
    (XOR     (AL Ib)  (34 ib)     ())
    (XOR     (AX Iw)  (35 iw)     ())
    (AAA     ()       (37)        ())
    (CMP     (Eb Gb)  (38 /r)     ())
    (CMP     (Ew Gw)  (39 /r)     ())
    (CMP     (Gb Eb)  (3A /r)     ())
    (CMP     (Gw Ew)  (3B /r)     ())
    (CMP     (AL Ib)  (3C ib)     ())
    (CMP     (AX Iw)  (3D iw)     ())
    (AAS     ()       (3F)        ())
    (INC     (Zw)     (40+r)      ())
    (DEC     (Zw)     (48+r)      ())
    (PUSH    (Zw)     (50+r)      ())
    (POP     (Zw)     (58+r)      ())
    (Jcc     (Jb)     (70+cc ib)  (end-trace))
    (ADD     (Eb Ib)  (80 /0)     (lockable))
    (OR      (Eb Ib)  (80 /1)     (lockable))
    (ADC     (Eb Ib)  (80 /2)     (lockable))
    (SBB     (Eb Ib)  (80 /3)     (lockable))
    (AND     (Eb Ib)  (80 /4)     (lockable))
    (SUB     (Eb Ib)  (80 /5)     (lockable))
    (XOR     (Eb Ib)  (80 /6)     (lockable))
    (CMP     (Eb Ib)  (80 /7)     ())
    (ADD     (Ew Iw)  (81 /0)     (lockable))
    (OR      (Ew Iw)  (81 /1)     (lockable))
    (ADC     (Ew Iw)  (81 /2)     (lockable))
    (SBB     (Ew Iw)  (81 /3)     (lockable))
    (AND     (Ew Iw)  (81 /4)     (lockable))
    (SUB     (Ew Iw)  (81 /5)     (lockable))
    (XOR     (Ew Iw)  (81 /6)     (lockable))
    (CMP     (Ew Iw)  (81 /7)     ())
    (ADD     (Eb Ib)  (82 /0)     (lockable))  ; undocumented
    (OR      (Eb Ib)  (82 /1)     (lockable))  ; undocumented
    (ADC     (Eb Ib)  (82 /2)     (lockable))  ; undocumented
    (SBB     (Eb Ib)  (82 /3)     (lockable))  ; undocumented
    (AND     (Eb Ib)  (82 /4)     (lockable))  ; undocumented
    (SUB     (Eb Ib)  (82 /5)     (lockable))  ; undocumented
    (XOR     (Eb Ib)  (82 /6)     (lockable))  ; undocumented
    (CMP     (Eb Ib)  (82 /7)     ())          ; undocumented
    (ADD     (Ew Ib)  (83 /0)     (lockable))
    (OR      (Ew Ib)  (83 /1)     (lockable))
    (ADC     (Ew Ib)  (83 /2)     (lockable))
    (SBB     (Ew Ib)  (83 /3)     (lockable))
    (AND     (Ew Ib)  (83 /4)     (lockable))
    (SUB     (Ew Ib)  (83 /5)     (lockable))
    (XOR     (Ew Ib)  (83 /6)     (lockable))
    (CMP     (Ew Ib)  (83 /7)     ())
    (TEST    (Eb Gb)  (84 /r)     ())
    (TEST    (Ew Gw)  (85 /r)     ())
    (XCHG    (Eb Gb)  (86 /r)     (lockable))
    (XCHG    (Ew Gw)  (87 /r)     (lockable))
    (MOV     (Eb Gb)  (88 /r)     ())
    (MOV     (Ew Gw)  (89 /r)     ())
    (MOV     (Gb Eb)  (8A /r)     ())
    (MOV     (Gw Ew)  (8B /r)     ())
    (MOV     (Ew Sw)  (8C /r)     ())
    (LEA     (Gw M)   (8D m/r)    ())
    (MOV     (Sw Ew)  (8E /r)     ())
    (POP     (Ew)     (8F /0)     ())
    (XCHG    (AX Zw)  (90+r)      ())
    (CBW     ()       (98)        ())
    (CWD     ()       (99)        ())
    (CALL    (Apww)   (9A ipw)    (end-trace))
    (WAIT    ()       (9B)        ())
    (PUSHF   ()       (9C)        ())
    (POPF    ()       (9D)        ())
    (SAHF    ()       (9E)        ())
    (LAHF    ()       (9F)        ())
    (MOV     (AL Ob)  (A0 ib)     ())
    (MOV     (AX Ow)  (A1 iw)     ())
    (MOV     (Ob AL)  (A2 ib)     ())
    (MOV     (Ow AX)  (A3 iw)     ())
    (MOVSB   ()       (A4)        ())
    (MOVSW   ()       (A5)        ())
    (CMPSB   ()       (A6)        ())
    (CMPSW   ()       (A7)        ())
    (TEST    (AL Ib)  (A8 ib)     ())
    (TEST    (AX Iw)  (A9 iw)     ())
    (STOSB   ()       (AA)        ())
    (STOSW   ()       (AB)        ())
    (LODSB   ()       (AC)        ())
    (LODSW   ()       (AD)        ())
    (SCASB   ()       (AE)        ())
    (SCASW   ()       (AF)        ())
    (MOV     (Zb Ib)  (B0+r)      ())
    (MOV     (Zw Iw)  (B8+r)      ())
    (RET     (Iw)     (C2 iw)     (end-trace))
    (RET     ()       (C3)        (end-trace))
    (LES     (Gw Mw)  (C4 m/r)    ())
    (LDS     (Gw Mw)  (C5 m/r)    ())
    (MOV     (Eb Ib)  (C6 /r ib)  ())
    (MOV     (Ew Iw)  (C7 /r iw)  ())
    (RETF    (Iw)     (CA iw)     (end-trace))
    (RETF    ()       (CB)        (end-trace))
    (INT     (3)      (CC)        (end-trace))
    (INT     (Ib)     (CD ib)     (end-trace))
    (INTO    ()       (CE)        (end-trace))
    (IRET    ()       (CF)        (end-trace))
    (ROL     (Eb 1)   (D0 /0)     ()) ; NOTE: /6 is not included here
    (ROR     (Eb 1)   (D0 /1)     ()) ; Despite being SHL on later processors, it
    (RCL     (Eb 1)   (D0 /2)     ()) ;   is SETMO on the 8086
    (RCR     (Eb 1)   (D0 /3)     ()) ; TODO: when did SETMO become SHL? Add Dx /6 there
    (SHL     (Eb 1)   (D0 /4)     ())
    (SHR     (Eb 1)   (D0 /5)     ())
    (SAR     (Eb 1)   (D0 /7)     ())
    (ROL     (Ew 1)   (D1 /0)     ())
    (ROR     (Ew 1)   (D1 /1)     ())
    (RCL     (Ew 1)   (D1 /2)     ())
    (RCR     (Ew 1)   (D1 /3)     ())
    (SHL     (Ew 1)   (D1 /4)     ())
    (SHR     (Ew 1)   (D1 /5)     ())
    (SAR     (Ew 1)   (D1 /7)     ())
    (ROL     (Eb CL)  (D2 /0)     ())
    (ROR     (Eb CL)  (D2 /1)     ())
    (RCL     (Eb CL)  (D2 /2)     ())
    (RCR     (Eb CL)  (D2 /3)     ())
    (SHL     (Eb CL)  (D2 /4)     ())
    (SHR     (Eb CL)  (D2 /5)     ())
    (SAR     (Eb CL)  (D2 /7)     ())
    (ROL     (Ew CL)  (D3 /0)     ())
    (ROR     (Ew CL)  (D3 /1)     ())
    (RCL     (Ew CL)  (D3 /2)     ())
    (RCR     (Ew CL)  (D3 /3)     ())
    (SHL     (Ew CL)  (D3 /4)     ())
    (SHR     (Ew CL)  (D3 /5)     ())
    (SAR     (Ew CL)  (D3 /7)     ())
    (AAM     (Ib)     (D4 ib)     ())
    (AAD     (Ib)     (D5 ib)     ())
    (SALC    ()       (D6)        ())
    (XLAT    ()       (D7)        ())
    (LOOPNE  (Jb)     (E0 ib)     (end-trace))
    (LOOPE   (Jb)     (E1 ib)     (end-trace))
    (LOOP    (Jb)     (E2 ib)     (end-trace))
    (JCXZ    (Jb)     (E3 ib)     (end-trace))
    (IN      (AL Ib)  (E4 ib)     ())
    (IN      (AX Ib)  (E5 ib)     ())
    (OUT     (Ib AL)  (E6 ib)     ())
    (OUT     (Ib AX)  (E7 ib)     ())
    (CALL    (Jw)     (E8 iw)     (end-trace))
    (JMP     (Jw)     (E9 iw)     (end-trace))
    (JMP     (Apww)   (EA ipw)    (end-trace))
    (JMP     (Jb)     (EB ib)     (end-trace))
    (IN      (AL DX)  (EC)        ())
    (IN      (AX DX)  (ED)        ())
    (OUT     (DX AL)  (EE)        ())
    (OUT     (DX AX)  (EF)        ())
    (HLT     ()       (F4)        (end-trace))
    (CMC     ()       (F5)        ())
    (TEST    (Eb Ib)  (F6 /0 ib)  ())
    (TEST    (Eb Ib)  (F6 /1 ib)  ()) ; TODO: do non Intel processors do this?
    (NOT     (Eb)     (F6 /2)     ())
    (NEG     (Eb)     (F6 /3)     ())
    (MUL     (Eb)     (F6 /4)     ())
    (IMUL    (Eb)     (F6 /5)     ())
    (DIV     (Eb)     (F6 /6)     ())
    (IDIV    (Eb)     (F6 /7)     ())
    (TEST    (Ew Iw)  (F7 /0 iw)  ())
    (TEST    (Ew Iw)  (F7 /1 iw)  ()) ; TODO: do non Intel processors do this?
    (NOT     (Ew)     (F7 /2)     ())
    (NEG     (Ew)     (F7 /3)     ())
    (MUL     (Ew)     (F7 /4)     ())
    (IMUL    (Ew)     (F7 /5)     ())
    (DIV     (Ew)     (F7 /6)     ())
    (IDIV    (Ew)     (F7 /7)     ())
    (CLC     ()       (F8)        ())
    (STC     ()       (F9)        ())
    (CLI     ()       (FA)        ())
    (STI     ()       (FB)        ())
    (CLD     ()       (FC)        ())
    (STD     ()       (FD)        ())
    (INC     (Eb)     (FE /0)     ())
    (DEC     (Eb)     (FE /1)     ())
    (INC     (Ew)     (FF /0)     ())
    (DEC     (Ew)     (FF /1)     ())
    (CALL    (Ew)     (FF m/2)    (end-trace))
    (CALL    (Mpww)   (FF m/3)    (end-trace))
    (JMP     (Ew)     (FF m/4)    (end-trace))
    (JMP     (Mpww)   (FF m/5)    (end-trace))
    (PUSH    (Ew)     (FF /6)     ())
)
